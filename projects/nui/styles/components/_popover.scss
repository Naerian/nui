@use '../mixins' as global;
@use '../mixins-base' as base;
@use '../variables/popover-vars' as vars;

@mixin popover-theme($color: null, $variant: 'solid') {
  @if $color {
    // === IT HAS A DEFINED COLOR (Primary, Danger, etc.) ===
    @if $variant == 'solid' {
      --popover-bg: var(--nui-popover-#{$color}-bg);
      --popover-text: var(--nui-popover-#{$color}-text);
      --popover-border-color: var(--nui-popover-#{$color}-border);
      --popover-arrow-filter: none;
    }

    @if $variant == 'outline' {
      --popover-bg: var(--nui-popover-surface-bg);
      --popover-text: var(--nui-popover-#{$color}-bg);
      --popover-border-color: var(--nui-popover-#{$color}-outline-border);
      --popover-shadow: var(--nui-popover-shadow);
    }

    @if $variant == 'ghost' {
      --popover-bg: var(--nui-popover-#{$color}-ghost-bg);
      --popover-text: var(--nui-popover-#{$color}-ghost-text);
      --popover-border-color: transparent;
      --popover-shadow: var(--nui-popover-shadow);
    }
  } @else {
    // === NO COLOR (Surface Default) ===
    --popover-bg: var(--nui-popover-surface-bg);
    --popover-text: var(--nui-popover-surface-text);
    --popover-border-color: var(--nui-popover-surface-border);
    --popover-shadow: var(--nui-popover-shadow);
  }
}

@mixin nui-popover-styles {
  .nui-popover-overlay-pane {
    z-index: 1060 !important;
    pointer-events: none;

    .nui-popover {
      pointer-events: auto;
    }
  }

  .nui-popover-overlay {
    z-index: var(--nui-popover-z-index);
  }

  .nui-popover {
    @include popover-theme(null);

    position: relative;
    display: block;
    max-width: var(--nui-popover-max-width);
    min-width: var(--nui-popover-min-width);
    padding: var(--nui-popover-padding);
    background-color: var(--popover-bg);
    color: var(--popover-text);
    border: var(--nui-popover-border-width) solid var(--popover-border-color);
    border-radius: var(--nui-popover-border-radius);
    box-shadow: var(--nui-popover-shadow);
    transform-origin: center center;
    transition:
      opacity var(--nui-popover-transition-duration) var(--nui-popover-transition-timing),
      transform var(--nui-popover-transition-duration) var(--nui-popover-transition-timing);

    &__content {
      font-size: var(--nui-popover-font-size);
      font-weight: var(--nui-popover-font-weight);
      line-height: var(--nui-popover-line-height);
      overflow: visible;

      p {
        margin: 0;
        &:not(:last-child) {
          margin-bottom: 0.5rem;
        }
      }

      strong,
      b {
        font-weight: var(--nui-font-weight-semibold);
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        margin: 0 0 0.5rem 0;
        font-weight: var(--nui-font-weight-semibold);
        color: var(--popover-text);
      }
      h1 {
        font-size: var(--nui-font-size-lg);
      }
      h2 {
        font-size: var(--nui-font-size-md);
      }
      h3,
      h4,
      h5,
      h6 {
        font-size: var(--nui-font-size-sm);
      }

      ul,
      ol {
        margin: 0;
        padding-left: 1.5rem;
        &:not(:last-child) {
          margin-bottom: 0.5rem;
        }
        li {
          margin-bottom: 0.25rem;
        }
      }

      button,
      .nui-button {
        margin-top: 0.5rem;
        &:not(:last-child) {
          margin-right: 0.5rem;
        }
      }

      a {
        color: var(--nui-color-primary);
        text-decoration: underline;
        &:hover {
          color: var(--nui-color-primary-hover);
        }
      }

      hr {
        margin: 0.75rem 0;
        border: none;
        border-top: 1px solid var(--popover-border-color);
      }
    }

    &--scrollable &__content {
      overflow: auto;
      max-height: 60vh;
    }

    &.nui-popover-loading &__content {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 3rem;
      &::after {
        content: '';
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid var(--popover-border-color);
        border-top-color: var(--nui-color-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
    }

    &.nui-popover-compact &__content {
      padding: calc(var(--nui-popover-padding) / 2);
      font-size: var(--nui-font-size-xs);
    }
    &.nui-popover-wide {
      max-width: 30rem;
    }

    &.nui-popover-left &__content {
      text-align: left;
    }
    &.nui-popover-center &__content {
      text-align: center;
    }
    &.nui-popover-right &__content {
      text-align: right;
    }

    &__arrow {
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
    }

    // Positioning based on data-position attribute (top, bottom, left, right)
    &[data-position='top'] {
      margin-bottom: var(--nui-popover-distance);
      transform-origin: bottom center;
    }

    &[data-position='bottom'] {
      margin-top: var(--nui-popover-distance);
      transform-origin: top center;
    }

    &[data-position='left'] {
      margin-right: var(--nui-popover-distance);
      transform-origin: center right;
    }

    &[data-position='right'] {
      margin-left: var(--nui-popover-distance);
      transform-origin: center left;
    }

    // Arrow positioning based on data-position attribute (top, bottom, left, right)
    &[data-position='top'] &__arrow {
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 8px 8px 0 8px;
      border-color: var(--popover-bg) transparent transparent transparent;
      filter: drop-shadow(0 1px 0 var(--popover-border-color));
    }

    &[data-position='bottom'] &__arrow {
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 0 8px 8px 8px;
      border-color: transparent transparent var(--popover-bg) transparent;
      filter: drop-shadow(0 -1px 0 var(--popover-border-color));
    }

    &[data-position='left'] &__arrow {
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 8px 0 8px 8px;
      border-color: transparent transparent transparent var(--popover-bg);
      filter: drop-shadow(1px 0 0 var(--popover-border-color));
    }

    &[data-position='right'] &__arrow {
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      border-width: 8px 8px 8px 0;
      border-color: transparent var(--popover-bg) transparent transparent;
      filter: drop-shadow(-1px 0 0 var(--popover-border-color));
    }

    // --- GENERATION OF COLOR & VARIANTS ---
    $colors: primary, secondary, success, info, warning, danger, accent;
    $variants: solid, outline, ghost;
    @each $color in $colors {
      &--#{$color} {
        @include popover-theme($color);

        @each $variant in $variants {
          &.nui-popover--#{$variant} {
            @include popover-theme($color, $variant);

            // If variant is solid or ghost, remove arrow filter to make it the same color as the background/text
            @if $variant == 'solid' {
              .nui-popover__arrow {
                filter: none;
              }
            }

            // For ghost variant, we also remove the filter but keep the shadow for better
            // visibility since the background is transparent
            @if $variant == 'ghost' {
              backdrop-filter: blur(2px);
              -webkit-backdrop-filter: blur(2px);
              .nui-popover__arrow {
                filter: none;
              }
            }
          }
        }
      }
    }
  }

  // Utils
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .nui-popover:focus-visible {
    outline: 2px solid var(--nui-color-primary);
    outline-offset: 2px;
  }

  .nui-popover-backdrop {
    @include global.overlay-backdrop();
  }

  // Responsive mode (popover should never exceed viewport width on mobile)
  @include global.media-xs {
    .nui-popover,
    .nui-popover.nui-popover-wide {
      max-width: calc(100vw - 2rem);
    }
  }
}
