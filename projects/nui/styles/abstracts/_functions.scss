@use 'sass:color';
@use 'sass:list';
@use 'sass:map';
@use 'sass:math';

// ========================================
// COLOR FUNCTIONS
// ========================================

/// Lightens a color by mixing it with white
/// @group Color
/// @access public
/// @param {Color} $color - Base color to lighten
/// @param {Number} $percentage - Percentage of white to mix (0–100)
/// @return {Color} Lightened color
/// @example
///   tint(#14b8a6, 50%)
@function tint($color, $percentage) {
  @return color.mix(white, $color, $percentage);
}

/// Darkens a color by mixing it with black
/// @group Color
/// @access public
/// @param {Color} $color - Base color to darken
/// @param {Number} $percentage - Percentage of black to mix (0–100)
/// @return {Color} Darkened color
/// @example
///   shade(#14b8a6, 50%)
@function shade($color, $percentage) {
  @return color.mix(black, $color, $percentage);
}

/// Creates a color with alpha transparency
/// @group Color
/// @access public
/// @param {Color} $color - Base color
/// @param {Number} $alpha - Alpha value (0–1)
/// @return {Color} Color with transparency
/// @example
///   with-alpha(#14b8a6, 0.5)
@function with-alpha($color, $alpha) {
  @return rgba($color, $alpha);
}

// ========================================
// SPACING & SIZE FUNCTIONS
// ========================================

/// Removes the unit from a numeric value
/// @group Spacing
/// @access public
/// @param {Number} $value - Value with unit (px, rem, em, etc.)
/// @return {Number} Unitless value
/// @example
///   strip-unit(16px) // 16
@function strip-unit($value) {
  @return calc($value / ($value * 0 + 1));
}

/// Converts px values to rem
/// @group Spacing
/// @access public
/// @param {Number} $px - Value in pixels
/// @param {Number} $base [16px] - Base font size
/// @return {Number} Value in rem
/// @example
///   px-to-rem(24px) // 1.5rem
@function px-to-rem($px, $base: 16px) {
  @if math.unit($px) != 'px' {
    @error "px-to-rem() expects a value in px, received: #{$px}";
  }
  @return calc(strip-unit($px) / strip-unit($base)) * 1rem;
}

/// Converts rem values to px
/// @group Spacing
/// @access public
/// @param {Number} $rem - Value in rem
/// @param {Number} $base [16px] - Base font size
/// @return {Number} Value in pixels
/// @example
///   rem-to-px(1.5rem) // 24px
@function rem-to-px($rem, $base: 16px) {
  @if math.unit($rem) != 'rem' {
    @error "rem-to-px() expects a value in rem, received: #{$rem}";
  }
  @return calc(strip-unit($rem) * strip-unit($base)) * 1px;
}

// ========================================
// SHADOW FUNCTIONS
// ========================================

/// Generates box-shadow with dynamic opacity
/// @group Shadow
/// @access public
/// @param {String} $shadow-base - Shadow offsets, blur, and spread
/// @param {Number} $opacity - Shadow opacity (0–1)
/// @param {Color} $color [null] - Optional shadow color
/// @return {String} Box-shadow declaration
/// @example
///   shadow(0 2px 4px, 0.1)
@function shadow($shadow-base, $opacity, $color: null) {
  $final-color: rgba(
    var(--nui-shadow-base-rgb),
    calc(#{$opacity} * var(--nui-shadow-opacity-scale))
  );

  @if $color != null {
    $final-color: $color;
  }

  @return #{$shadow-base} #{$final-color};
}

/// Generates multi-layer shadows
/// @group Shadow
/// @access public
/// @param {List} $layers - List of layers: (base, opacity, optional color)
/// @return {String} Combined multi-layer box-shadow
/// @example
///   $layers: ((0 1px 3px, 0.12), (0 1px 2px, 0.24))
///   shadow-layers($layers)
@function shadow-layers($layers) {
  $result: ();

  @each $layer in $layers {
    $base: list.nth($layer, 1);
    $opacity: list.nth($layer, 2);
    $color: black;

    @if list.length($layer) > 2 {
      $color: list.nth($layer, 3);
    }

    $result: list.append($result, shadow($base, $opacity, $color), comma);
  }

  @return $result;
}

// ========================================
// MAP UTILITY FUNCTIONS
// ========================================

/// Retrieves a value from a map with fallback
/// @group Map
/// @access public
/// @param {Map} $map - SCSS map
/// @param {String} $key - Key to retrieve
/// @param {*} $fallback [null] - Default value
/// @return {*} Map value or fallback
/// @example
///   map-get-default($heights, md, 2.5rem)
@function map-get-default($map, $key, $fallback: null) {
  @if map.has-key($map, $key) {
    @return map.get($map, $key);
  }
  @return $fallback;
}

// ========================================
// CONTRAST & ACCESSIBILITY FUNCTIONS
// ========================================

/// Calculates relative luminance of a color
/// @group Accessibility
/// @access public
/// @param {Color} $color - Color to analyze
/// @return {Number} Luminance (0–1)
/// @example
///   luminance(#ffffff) // 1
@function luminance($color) {
  $red: color.red($color) / 255;
  $green: color.green($color) / 255;
  $blue: color.blue($color) / 255;

  @if $red <= 0.03928 {
    $red: calc($red / 12.92);
  } @else {
    $red: calc(pow(($red + 0.055) / 1.055, 2.4));
  }

  @if $green <= 0.03928 {
    $green: calc($green / 12.92);
  } @else {
    $green: calc(pow(($green + 0.055) / 1.055, 2.4));
  }

  @if $blue <= 0.03928 {
    $blue: calc($blue / 12.92);
  } @else {
    $blue: calc(pow(($blue + 0.055) / 1.055, 2.4));
  }

  @return $red * 0.2126 + $green * 0.7152 + $blue * 0.0722;
}

/// Calculates contrast ratio between two colors
/// @group Accessibility
/// @access public
/// @param {Color} $foreground - Text color
/// @param {Color} $background - Background color
/// @return {Number} Contrast ratio (1–21)
/// @example
///   contrast-ratio(#000000, #ffffff)
@function contrast-ratio($foreground, $background) {
  $lum1: luminance($foreground);
  $lum2: luminance($background);

  @if $lum1 > $lum2 {
    @return calc(($lum1 + 0.05) / ($lum2 + 0.05));
  } @else {
    @return calc(($lum2 + 0.05) / ($lum1 + 0.05));
  }
}

/// Selects the best text color (light or dark) based on contrast
/// @group Accessibility
/// @access public
/// @param {Color} $background - Background color
/// @param {Color} $light [white] - Text for dark backgrounds
/// @param {Color} $dark [black] - Text for light backgrounds
/// @return {Color} Color with higher contrast
/// @example
///   contrast-color(#14b8a6)
@function contrast-color($background, $light: white, $dark: black) {
  $light-contrast: contrast-ratio($light, $background);
  $dark-contrast: contrast-ratio($dark, $background);

  @if $light-contrast > $dark-contrast {
    @return $light;
  } @else {
    @return $dark;
  }
}
