<div
  class="nui-time-picker"
  [class.nui-time-picker--disabled]="isDisabled()"
  [class.nui-time-picker--duration]="isDurationMode()"
  [class.nui-time-picker--with-tabs]="shouldShowTabs()"
  [class.nui-time-picker--with-seconds]="isDurationMode() && config.duration.showSeconds"
  role="group"
  [attr.aria-label]="isDurationMode() ? 'Duration picker' : 'Time picker'"
>
  <!-- SISTEMA DE PESTAÑAS (cuando hay presets personalizados) -->
  @if (shouldShowTabs()) {
    <div class="nui-time-picker__tabs">
      <nui-btn-group
        [width]="'full'"
        [options]="tabOptions()"
        [ngModel]="activeTab()"
        (ngModelChange)="onTabChange($event)"
        mode="radio"
        visualVariant="segmented"
        size="sm"
        class="nui-time-picker__tabs-toggle"
      />
    </div>
  }

  <!-- VISTA DE MODO DURATION -->
  @if (isDurationMode() && (!shouldShowTabs() || activeTab() === 'selector')) {
    <div class="nui-time-picker__duration-view">
      <!-- Header: Display de duración -->
      @if (showHeader()) {
        <div class="nui-time-picker__header">
          <div
            class="nui-time-picker__display nui-time-picker__display--duration"
            role="status"
            aria-live="polite"
            [innerHTML]="formattedTime()"
          ></div>
        </div>
      }

      <!-- Selectores de duración -->
      <div class="nui-time-picker__selectors nui-time-picker__selectors--duration">
        <!-- Columna de HORAS -->
        <div
          class="nui-time-picker__column nui-time-picker__column--duration-hours"
          role="listbox"
          [attr.aria-label]="_translations.timePicker.duration.hours"
          tabindex="0"
          (keydown)="onKeyDown($event, 'duration-hours')"
          (focus)="onColumnFocus('duration-hours')"
        >
          <div class="nui-time-picker__column-label">
            {{ _translations.timePicker.duration.hours }}
          </div>

          <div class="nui-time-picker__column-items" #durationHoursColumn>
            @for (hour of availableDurationHours(); track hour) {
              <button
                type="button"
                class="nui-time-picker__item nui-time-picker__item--duration"
                [class.nui-time-picker__item--selected]="selectedDuration()?.hours === hour"
                [class.nui-time-picker__item--focused]="
                  focusedSection() === 'duration-hours' && selectedDuration()?.hours === hour
                "
                [disabled]="isDisabled()"
                [attr.data-duration-hours]="hour"
                (click)="selectDurationHours(hour)"
                role="option"
                [attr.aria-selected]="selectedDuration()?.hours === hour"
                [attr.tabindex]="selectedDuration()?.hours === hour ? 0 : -1"
              >
                <span class="nui-time-picker__duration-value">{{ hour }}</span>
                <span class="nui-time-picker__duration-unit">h</span>
              </button>
            }
          </div>
        </div>

        <!-- Columna de MINUTOS -->
        <div
          class="nui-time-picker__column nui-time-picker__column--duration-minutes"
          role="listbox"
          [attr.aria-label]="_translations.timePicker.duration.minutes"
          tabindex="0"
          (keydown)="onKeyDown($event, 'duration-minutes')"
          (focus)="onColumnFocus('duration-minutes')"
        >
          <div class="nui-time-picker__column-label">
            {{ _translations.timePicker.duration.minutes }}
          </div>

          <div class="nui-time-picker__column-items" #durationMinutesColumn>
            @for (minute of availableDurationMinutes(); track minute) {
              <button
                type="button"
                class="nui-time-picker__item nui-time-picker__item--duration"
                [class.nui-time-picker__item--selected]="selectedDuration()?.minutes === minute"
                [class.nui-time-picker__item--focused]="
                  focusedSection() === 'duration-minutes' && selectedDuration()?.minutes === minute
                "
                [disabled]="isDisabled()"
                [attr.data-duration-minutes]="minute"
                (click)="selectDurationMinutes(minute)"
                role="option"
                [attr.aria-selected]="selectedDuration()?.minutes === minute"
                [attr.tabindex]="selectedDuration()?.minutes === minute ? 0 : -1"
              >
                <span class="nui-time-picker__duration-value">{{ minute }}</span>
                <span class="nui-time-picker__duration-unit">min</span>
              </button>
            }
          </div>
        </div>

        <!-- Columna de SEGUNDOS (opcional) -->
        @if (config.duration.showSeconds) {
          <div
            class="nui-time-picker__column nui-time-picker__column--duration-seconds"
            role="listbox"
            [attr.aria-label]="_translations.timePicker.duration.seconds"
            tabindex="0"
            (keydown)="onKeyDown($event, 'duration-seconds')"
            (focus)="onColumnFocus('duration-seconds')"
          >
            <div class="nui-time-picker__column-label">
              {{ _translations.timePicker.duration.seconds }}
            </div>

            <div class="nui-time-picker__column-items" #durationSecondsColumn>
              @for (second of availableDurationSeconds(); track second) {
                <button
                  type="button"
                  class="nui-time-picker__item nui-time-picker__item--duration"
                  [class.nui-time-picker__item--selected]="selectedDuration()?.seconds === second"
                  [class.nui-time-picker__item--focused]="
                    focusedSection() === 'duration-seconds' &&
                    selectedDuration()?.seconds === second
                  "
                  [disabled]="isDisabled()"
                  [attr.data-duration-seconds]="second"
                  (click)="selectDurationSeconds(second)"
                  role="option"
                  [attr.aria-selected]="selectedDuration()?.seconds === second"
                  [attr.tabindex]="selectedDuration()?.seconds === second ? 0 : -1"
                >
                  <span class="nui-time-picker__duration-value">{{ second }}</span>
                  <span class="nui-time-picker__duration-unit">s</span>
                </button>
              }
            </div>
          </div>
        }
      </div>

      <!-- Footer con controles -->
      <div class="nui-time-picker__footer">
        <button
          type="button"
          class="nui-time-picker__footer-btn"
          (click)="clear()"
          [disabled]="isDisabled() || !selectedDuration()"
          [attr.aria-label]="_translations.timePicker.clear"
        >
          {{ _translations.timePicker.clear }}
        </button>
      </div>
    </div>
  }

  <!-- PESTAÑA DEL SELECTOR (solo para modo NO-DURATION) -->
  @if (!isDurationMode() && (!shouldShowTabs() || activeTab() === 'selector')) {
    <div class="nui-time-picker__main">
      <!-- Header: Display actual -->
      @if (showHeader()) {
        <div class="nui-time-picker__header">
          <!-- Indicador de normalización -->
          @if (normalizationInfo()) {
            <div
              class="nui-time-picker__normalized"
              role="alert"
              aria-live="assertive"
              [innerHTML]="
                _translations.timePicker.normalizedTime
                  .replace('{ original }', normalizationInfo()?.original ?? '')
                  .replace('{ normalized }', normalizationInfo()?.normalized ?? '')
              "
            ></div>
          }

          <!-- Indicador de rango (si está habilitado) -->
          @if (config.showRangeIndicator && config.minTime && config.maxTime) {
            <div class="nui-time-picker__range-indicator">
              <span class="nui-time-picker__range-label">
                {{ _translations.timePicker.rangeLabel }}:
              </span>
              <div class="nui-time-picker__range-values">
                <span class="nui-time-picker__range-start">
                  {{ formatTimeValue(config.minTime) }}
                </span>
                <span class="nui-time-picker__range-separator">—</span>
                <span class="nui-time-picker__range-end">
                  {{ formatTimeValue(config.maxTime) }}
                </span>
              </div>
            </div>
          }

          <div
            class="nui-time-picker__display"
            role="status"
            aria-live="polite"
            [innerHTML]="formattedTime()"
          ></div>
        </div>
      }

      <!-- Selectores -->
      <div class="nui-time-picker__selectors">
        <!-- Selector de Horas -->
        <div
          class="nui-time-picker__column"
          role="listbox"
          [attr.aria-label]="
            is12HourFormat() ? _translations.timePicker.hour12 : _translations.timePicker.hour24
          "
          [attr.aria-activedescendant]="
            selectedTime()?.hour ? 'hour-' + selectedTime()?.hour : null
          "
          [attr.aria-describedby]="'hour-help'"
          tabindex="0"
          (keydown)="onKeyDown($event, 'hour')"
          (focus)="onColumnFocus('hour')"
          (blur)="focusedSection.set(null)"
        >
          <div class="nui-time-picker__column-label">
            {{
              isDurationMode()
                ? _translations.timePicker.duration.hours
                : _translations.timePicker.hour
            }}
          </div>

          <!-- Ayuda oculta para lectores de pantalla -->
          <div id="hour-help" class="sr-only">
            Use arrow keys to navigate, Enter to select, Home/End for first/last
          </div>

          <div class="nui-time-picker__column-items" #hoursColumn>
            @for (hour of availableHours(); track hour) {
              <button
                type="button"
                [id]="'hour-' + hour"
                class="nui-time-picker__item"
                [class.nui-time-picker__item--selected]="selectedTime()?.hour === hour"
                [class.nui-time-picker__item--focused]="
                  focusedSection() === 'hour' && selectedTime()?.hour === hour
                "
                [disabled]="isDisabled()"
                [tabindex]="selectedTime()?.hour === hour ? 0 : -1"
                (click)="selectHour(hour)"
                (focus)="focusedSection.set('hour')"
                role="option"
                [attr.aria-selected]="selectedTime()?.hour === hour"
                [attr.data-hour]="hour"
              >
                {{ hour.toString().padStart(2, '0') }}
              </button>
            }
          </div>
        </div>

        <!-- Separador (solo si se muestran minutos) -->
        @if (showMinutes()) {
          <div class="nui-time-picker__separator">
            <div class="nui-time-picker__separator-line"></div>
            <div class="nui-time-picker__separator-text">:</div>
            <div class="nui-time-picker__separator-line"></div>
          </div>
        }

        <!-- Selector de Minutos -->
        @if (showMinutes()) {
          <div
            class="nui-time-picker__column"
            role="listbox"
            [attr.aria-label]="_translations.timePicker.minutes"
            [attr.aria-activedescendant]="
              selectedTime()?.minute !== undefined ? 'minute-' + selectedTime()?.minute : null
            "
            [attr.aria-describedby]="'minute-help'"
            tabindex="0"
            (keydown)="onKeyDown($event, 'minute')"
            (focus)="onColumnFocus('minute')"
            (blur)="focusedSection.set(null)"
          >
            <div class="nui-time-picker__column-label">
              {{
                isDurationMode()
                  ? _translations.timePicker.duration.minutes
                  : _translations.timePicker.minutes
              }}
            </div>

            <!-- Ayuda oculta para lectores de pantalla -->
            <div id="minute-help" class="sr-only">
              Use arrow keys to navigate, Enter to select, Home/End for first/last, PageUp/PageDown
              to skip 5 items
            </div>

            <div class="nui-time-picker__column-items" #minutesColumn>
              @for (minute of availableMinutes(); track minute) {
                <button
                  type="button"
                  [id]="'minute-' + minute"
                  class="nui-time-picker__item"
                  [class.nui-time-picker__item--selected]="selectedTime()?.minute === minute"
                  [class.nui-time-picker__item--focused]="
                    focusedSection() === 'minute' && selectedTime()?.minute === minute
                  "
                  [disabled]="isDisabled()"
                  [tabindex]="selectedTime()?.minute === minute ? 0 : -1"
                  (click)="selectMinute(minute)"
                  (focus)="focusedSection.set('minute')"
                  role="option"
                  [attr.aria-selected]="selectedTime()?.minute === minute"
                  [attr.data-minute]="minute"
                >
                  {{ minute.toString().padStart(2, '0') }}
                </button>
              }
            </div>
          </div>
        }
      </div>

      <!-- Selector AM/PM (solo formato 12h) -->
      @if (is12HourFormat()) {
        <div
          class="nui-time-picker__period"
          (keydown)="onKeyDown($event, 'period')"
          (focus)="onColumnFocus('period')"
        >
          <!-- Ayuda oculta para lectores de pantalla -->
          <div id="period-help" class="sr-only">
            Use arrow keys or Tab to navigate, Enter to select
          </div>

          <div
            class="nui-time-picker__period-toggle"
            role="radiogroup"
            [attr.aria-label]="_translations.timePicker.period || 'AM/PM'"
            [attr.aria-describedby]="'period-help'"
          >
            <nui-btn-group
              #periodColumn
              [options]="periodOptions()"
              [ngModel]="selectedPeriod()"
              (ngModelChange)="onPeriodChange($event)"
              [disabled]="isDisabled()"
              mode="radio"
              visualVariant="segmented"
              size="xs"
            />
          </div>
        </div>
      }

      <!-- Footer: Controles de acción -->
      <div class="nui-time-picker__footer">
        <button
          type="button"
          class="nui-time-picker__footer-btn"
          (click)="clear()"
          [disabled]="isDisabled() || !selectedTime()"
          [attr.aria-label]="_translations.timePicker.clear"
        >
          {{ _translations.timePicker.clear }}
        </button>

        @if (!isDurationMode()) {
          <!-- Si NO estamos en modo Duration, mostrar botón de "Ahora" -->
          <button
            type="button"
            class="nui-time-picker__footer-btn"
            (click)="setToNow()"
            [disabled]="isDisabled()"
            [attr.aria-label]="_translations.timePicker.setToCurrentTime"
          >
            {{ _translations.timePicker.setToCurrentTime }}
          </button>
        }
      </div>
    </div>
  }

  <!-- PESTAÑA DE PRESETS -->
  @if (shouldShowTabs() && activeTab() === 'presets') {
    <div class="nui-time-picker__presets-view">
      @for (preset of effectivePresets(); track preset.label) {
        <button
          type="button"
          class="nui-time-picker__preset-btn"
          (click)="applyPreset(preset)"
          [disabled]="isDisabled()"
        >
          @if (preset.icon) {
            <i [class]="preset.icon"></i>
          }
          <span>{{ preset.label }}</span>
        </button>
      }
    </div>
  }
</div>
